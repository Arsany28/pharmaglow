<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pharmaglow Admin Dashboard</title>

<style>
/* ================= PREMIUM DARK ADMIN ================= */
:root{
  --bg:#050712;
  --card:rgba(255,255,255,.05);
  --border:rgba(255,255,255,.1);
  --text:#ecf2ff;
  --muted:rgba(236,242,255,.65);
  --primary:#22d3ee;
  --accent:#a3e635;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family: system-ui, Arial;
  color:var(--text);
  background:
    radial-gradient(1000px 600px at 20% 0%, rgba(34,211,238,.15), transparent 60%),
    radial-gradient(900px 600px at 80% 0%, rgba(163,230,53,.12), transparent 60%),
    linear-gradient(180deg, #050712, #04040a);
}

/* Header */
header{
  position:sticky; top:0; z-index:10;
  padding:16px 20px;
  background:rgba(5,7,18,.8);
  backdrop-filter: blur(10px);
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  flex-wrap:wrap;
}

input, select{
  padding:10px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.04);
  color:var(--text);
}

/* Buttons */
.btn{
  padding:10px 14px;
  border-radius:12px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.05);
  color:var(--text);
  font-weight:700;
  cursor:pointer;
}
.btn.primary{
  background: linear-gradient(135deg, #22d3ee, #14b8a6);
  color:#021016;
  border:none;
}

/* Layout */
.wrap{
  width:min(1200px,92%);
  margin:20px auto;
  display:grid;
  gap:16px;
}

/* KPI Cards */
.kpis{
  display:grid;
  grid-template-columns: repeat(6, 1fr);
  gap:14px;
}
.kpi{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px;
}
.kpi .label{color:var(--muted); font-size:.9rem}
.kpi .value{font-size:1.8rem; font-weight:900; margin-top:6px}

/* Table */
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px;
}

table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  border-bottom:1px solid var(--border);
  padding:10px;
  vertical-align:top;
}
th{color:var(--muted); text-align:left}
tr:hover{background:rgba(255,255,255,.04)}
.muted{color:var(--muted)}
</style>
</head>

<body>

<header>
  <strong>Pharmaglow Admin Dashboard</strong>

  <div style="display:flex; gap:10px; flex-wrap:wrap">
    <input id="token" placeholder="Admin Token" style="width:240px">
    <button class="btn primary" id="saveToken">Save Token</button>
    <button class="btn" id="reloadAll" type="button">Reload Orders</button>
  </div>
</header>

<div class="wrap">

  <!-- KPIs -->
  <div class="kpis">
    <div class="kpi"><div class="label">New Orders</div><div class="value" id="kpiNew">0</div></div>
    <div class="kpi"><div class="label">Processing Orders</div><div class="value" id="kpiProcessing">0</div></div>
    <div class="kpi"><div class="label">Open Orders</div><div class="value" id="kpiTotalOpen">0</div></div>
    <div class="kpi"><div class="label">Open Revenue</div><div class="value" id="kpiRevenue">0 LE</div></div>
    <div class="kpi"><div class="label">All Orders</div><div class="value" id="kpiAllCount">0</div></div>
    <div class="kpi"><div class="label">All Revenue</div><div class="value" id="kpiAllRevenue">0 LE</div></div>
  </div>

  <!-- Orders Table -->
  <div class="card">
    <h3 style="margin:0 0 10px">Open Orders</h3>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Customer</th>
            <th>Items</th>
            <th>Total</th>
            <th>Status</th>
            <th>Save</th>
          </tr>
        </thead>
        <tbody id="ordersBody"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyIvfwILoqaBihI6nxSTV31-rZGooS7Ir703h_3Amya8tTCrUUxmcdgk_2SYrQuq_ZKOw/exec";

const $ = s=>document.querySelector(s);
const el = id=>document.getElementById(id);

function money(n){ return Number(n||0) + " LE"; }

function getToken(){ return localStorage.getItem("pg_admin_token")||""; }
function setToken(v){ localStorage.setItem("pg_admin_token", v); }

async function apiPost(payload){
  const res = await fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"text/plain;charset=utf-8"},
    body: JSON.stringify(payload)
  });
  return res.json();
}

/* ================= LOAD DASHBOARD ================= */
async function loadDashboard(){
  const token = getToken();
  if(!token){ alert("Enter Admin Token"); return; }

  const res = await fetch(API_URL+"?action=orders&token="+encodeURIComponent(token));
  const data = await res.json();
  if(!data.ok){ alert("Error loading orders"); return; }

  const all = data.orders || [];
  const open = all.filter(o=> String(o.status).toLowerCase() !== "done");

  // KPIs
  const newCount = open.filter(o=>o.status==="new").length;
  const procCount = open.filter(o=>o.status==="processing").length;

  const openRevenue = open.reduce((s,o)=>s+Number(o.total||0),0);
  const allRevenue = all.reduce((s,o)=>s+Number(o.total||0),0);

  el("kpiNew").textContent = newCount;
  el("kpiProcessing").textContent = procCount;
  el("kpiTotalOpen").textContent = open.length;
  el("kpiRevenue").textContent = money(openRevenue);
  el("kpiAllCount").textContent = all.length;
  el("kpiAllRevenue").textContent = money(allRevenue);

  // Table
  const tbody = el("ordersBody");
  tbody.innerHTML = "";

  if(open.length === 0){
    tbody.innerHTML = `<tr><td colspan="6" class="muted">No open orders.</td></tr>`;
    return;
  }

  open.forEach(o=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><strong>${o.order_id}</strong><div class="muted">${o.created_at}</div></td>
      <td><strong>${o.name}</strong><br>${o.phone}<br><span class="muted">${o.address}</span></td>
      <td style="white-space:pre-wrap">${o.items}</td>
      <td><strong>${o.total} LE</strong></td>
      <td>
        <select data-status="${o.order_id}">
          <option value="new" ${o.status==="new"?"selected":""}>new</option>
          <option value="processing" ${o.status==="processing"?"selected":""}>processing</option>
          <option value="done" ${o.status==="done"?"selected":""}>done</option>
        </select>
      </td>
      <td><button class="btn" data-save="${o.order_id}">Save</button></td>
    `;
    tbody.appendChild(tr);
  });

  document.querySelectorAll("[data-save]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.getAttribute("data-save");
      const sel = document.querySelector(`[data-status="${id}"]`);
      const status = sel.value;

      const out = await apiPost({
        action:"admin_update_order_status",
        admin_token:getToken(),
        order_id:id,
        status
      });

      if(out.ok) loadDashboard();
      else alert("Error saving");
    });
  });
}

/* ================= INIT ================= */
el("token").value = getToken();

el("saveToken").onclick = ()=>{
  setToken(el("token").value.trim());
  alert("Token saved");
};

el("reloadAll").onclick = loadDashboard;

if(getToken()) loadDashboard();
</script>

</body>
</html>
